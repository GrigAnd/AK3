Транслятор и модель

- Григорьев Андрей P33111.
- `lisp -> asm | acc | harv | hw | tick -> instr | struct | stream | mem | pstr | prob5 | [4]char`
- Упрощенный вариант

## Язык программирования
Синтаксис предполагается похожим на NASM
``` ebnf
program ::= {instruction}
instruction ::= opcode [operand] | label ":" | label ":" db value [dup]
opcode ::= "LD" | "ST" | "SUB" | "ADD" | "DIVR" | "INC" | "DEC" | "JMP" | "JNZ" | "JZ" | "JN" | "HLT" | "CLR"
operand ::= number | label
indirect_operand ::= "[" operand "]"
value ::= number | string
number ::= {digit} | "0x" {hex_digit}
string ::= '"' {text, except '"'} '"'
label ::= {alpha, except '['} {alpha | digit}
dup ::= "dup" 
<!-- if dup - value = length of buffer-->
comment ::= ";" {text}
code_section ::= "SECTION .text"
data_section ::= "SECTION .data"
```
По умолчанию адресация прямая, при заключени операнда в квадратные скобки, адресация косвенная.

Повторное объявлени метки запрещено.

## Организация памяти

- Program memory: машинное слово -- не определено. Реализуется списком словарей.
- Data memory: машинное слово -- 32 бита, знаковое. Реализуется именованным массивом.

```text
Program memory
+-----------------------------+
| 0:  LD  4343                |
| 1:  INC                     |
| 2:  ST  4242                |
|                             |
| n:  JMP 0                   |
+-----------------------------+

Data memory
+-----------------------------+
| 0: var                      |
|    ...                      |
| 1023: var                   |
| 4242: out port              |
| 4343: in port               |
+-----------------------------+
```
## Система команд


Особенности процессора:
- Машинное слово -- 32 бит, знаковое.
- `Память`:
    - адресуется через регистр `data_address`;
    - запись из аккумулятора
    - может быть прочитана:
        - в acc;
        - в data_address;
- Ввод-вывод -- MMIO.
- `program_counter` -- счётчик команд:
    - инкрементируется после каждой инструкции или перезаписывается инструкцией перехода (MUX is_jmp).


### Набор инструкций

| Opcode | Такты | Описание |
|--------|-------|----------|
|LD`<addr>`|2-4| загрузка из памяти данных в аккумуляторб поддерживает косвенную адресацию
|ST`<addr>`|2-4| сохранение из аккумулятора в память данных, поддерживает косвенную адресацию
|SUB`<addr>`|1| вычитание из аккумулятора
|ADD`<addr>`|1| сложение с аккумулятором
|CLR|1| обнуление аккумулятора
|DIVR`<addr>`|1| остаток от деления аккумулятора на значение
|INC|2| инкремент аккумулятора
|DEC|2| декремент аккумулятора
|JMP`<addr>`|1| безусловный переход
|JNZ`<addr>`|2| переход, если аккумулятор не равен нулю
|JZ`<addr>`|2| переход, если аккумулятор равен нулю
|JN`<addr>`|2| переход, если аккумулятор отрицателен
|HLT|0| остановка



### Кодирование инструкций

- Машинный код сериализуется в массив JSON.
- Один элемент списка, одна инструкция.


Пример:

```json
[
   {
        "position": 0, 
        "opcode": "LD", 
        "operand": 19, 
        "op_type": "INDIRECT", 
        "src_line": 17
    }
]
```

где:
- `position` -- позиция в памяти программы;
- `opcode` -- строка с кодом операции;
- `operand` -- аргумент (может отсутствовать);
- `op_type` -- тип адресации;
- `src_line` -- номер строки исходного кода.


## Транслятор

Интерфейс командной строки: `translator.py <input_file> <target_code_file> <target_data_file>"`

Реализовано в модуле: [translator](./translator.py)

Этапы трансляции (функция `translate`):
1. Трансформирование текста в последовательность значимых термов.
2. Указание типа операнда
3. Подстановка лейблов



## Модель процессора

Интерфейс командной строки: `model.py <code_file> <data_file> <input_file>`



- `latch_data_address` -- защёлкнуть значение в `data_address`

### DataPath


### ControlUnit


Реализован в классе `ControlUnit`.

- Hardwired.
- Моделирование на уровне инструкций.
